<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Abidin BLE Chat üîµ</title>
<style>
  body { font-family: sans-serif; background: #0a84ff; color: #fff; text-align: center; padding: 40px; }
  .chat-box { background: rgba(255,255,255,0.15); border-radius: 10px; padding: 20px; max-width: 400px; margin: auto; }
  input { width: 80%; padding: 8px; border-radius: 8px; border: none; margin-top: 10px; }
  button { padding: 10px 15px; border: none; border-radius: 8px; background: #fff; color: #0a84ff; font-weight: bold; cursor: pointer; }
  #messages { background: rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; text-align: left; height: 200px; overflow-y: auto; margin-bottom: 10px; }
</style>
</head>
<body>
<h1>Abidin BLE Chat üí¨</h1>
<div class="chat-box">
  <div id="messages"></div>
  <input id="msg" placeholder="Tulis pesan..." />
  <button id="sendBtn">Kirim</button><br><br>
  <button id="connectBtn">üîó Hubungkan BLE</button>
</div>

<script>
let writeChar, notifyChar;

async function connectBLE() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: ['0000ffe0-0000-1000-8000-00805f9b34fb']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
    
    writeChar = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
    notifyChar = writeChar; // sama characteristic bisa read/write

    await notifyChar.startNotifications();
    notifyChar.addEventListener('characteristicvaluechanged', handleIncoming);

    addMsg("‚úÖ Terhubung ke " + device.name);
  } catch (e) {
    addMsg("‚ùå Gagal: " + e);
  }
}

function handleIncoming(event) {
  const decoder = new TextDecoder();
  const msg = decoder.decode(event.target.value);
  addMsg("üì• Dari perangkat: " + msg);
}

async function sendMsg() {
  if (!writeChar) return addMsg("‚ö†Ô∏è Hubungkan dulu!");
  const text = document.getElementById('msg').value;
  if (!text) return;
  const encoder = new TextEncoder();
  await writeChar.writeValue(encoder.encode(text));
  addMsg("üì§ Kamu: " + text);
  document.getElementById('msg').value = '';
}

function addMsg(text) {
  const box = document.getElementById('messages');
  box.innerHTML += `<div>${text}</div>`;
  box.scrollTop = box.scrollHeight;
}

document.getElementById('connectBtn').onclick = connectBLE;
document.getElementById('sendBtn').onclick = sendMsg;
</script>
</body>
</html>
